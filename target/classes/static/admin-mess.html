<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin | Manage Mess Menu</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; padding: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        select, input { padding: 12px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        .btn-action { padding: 12px 25px; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; transition: 0.3s; }
        .btn-add { background: #10b981; color: white; }
        .btn-update { background: #3b82f6; color: white; display: none; }
        .btn-cancel { background: #64748b; color: white; display: none; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #6366f1; color: white; }
        .btn-edit { background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .btn-del { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="formTitle">Add New Menu Item</h2>
    <input type="hidden" id="editItemId"> <div class="controls">
    <select id="day">
        <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
        <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
    </select>
    <select id="mealType">
        <option>Breakfast</option><option>Lunch</option><option>Dinner</option>
    </select>
    <input type="text" id="itemName" placeholder="Enter Dish Name" style="flex:1;">

    <button id="addBtn" onclick="saveItem('POST')" class="btn-action btn-add">Add Item</button>
    <button id="updateBtn" onclick="saveItem('PUT')" class="btn-action btn-update">Update Item</button>
    <button id="cancelBtn" onclick="resetForm()" class="btn-action btn-cancel">Cancel</button>
</div>
</div>

<div class="card">
    <h3>Live Menu Preview</h3>
    <table>
        <thead>
        <tr><th>Day</th><th>Meal Type</th><th>Dish</th><th>Actions</th></tr>
        </thead>
        <tbody id="menuBody"></tbody>
    </table>
</div>

<script>
    const API = "http://localhost:8080/api/mess";

    async function loadTable() {
        const res = await fetch(`${API}/all`);
        const items = await res.json();
        const body = document.getElementById("menuBody");
        body.innerHTML = "";

        const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        items.sort((a,b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));

        items.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item.day}</td>
                <td><strong>${item.mealType}</strong></td>
                <td>${item.itemName}</td>
                <td>
                    <button class="btn-edit" onclick='startEdit(${JSON.stringify(item)})'>Edit</button>
                    <button class="btn-del" onclick="deleteItem(${item.id})">Remove</button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    async function saveItem(method) {
        const id = document.getElementById("editItemId").value;
        const item = {
            id: id ? id : null,
            day: document.getElementById("day").value,
            mealType: document.getElementById("mealType").value,
            itemName: document.getElementById("itemName").value
        };

        if(!item.itemName) return Swal.fire("Error", "Item name is required", "error");

        const url = method === 'PUT' ? `${API}/update` : `${API}/add`;

        await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(item)
        });

        Swal.fire("Success", `Item ${method === 'PUT' ? 'updated' : 'added'}!`, "success");
        resetForm();
        loadTable();
    }

    function startEdit(item) {
        // Change UI to Edit Mode
        document.getElementById("formTitle").innerText = "Update Menu Item";
        document.getElementById("editItemId").value = item.id;
        document.getElementById("day").value = item.day;
        document.getElementById("mealType").value = item.mealType;
        document.getElementById("itemName").value = item.itemName;

        document.getElementById("addBtn").style.display = "none";
        document.getElementById("updateBtn").style.display = "inline-block";
        document.getElementById("cancelBtn").style.display = "inline-block";

        window.scrollTo(0,0); // Scroll up to see the form
    }

    function resetForm() {
        document.getElementById("formTitle").innerText = "Add New Menu Item";
        document.getElementById("editItemId").value = "";
        document.getElementById("itemName").value = "";

        document.getElementById("addBtn").style.display = "inline-block";
        document.getElementById("updateBtn").style.display = "none";
        document.getElementById("cancelBtn").style.display = "none";
    }

    async function deleteItem(id) {
        const res = await Swal.fire({
            title: 'Are you sure?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444'
        });
        if(res.isConfirmed) {
            await fetch(`${API}/remove/${id}`, { method: 'DELETE' });
            loadTable();
        }
    }

    window.onload = loadTable;
</script>
</body>
</html>