<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin | Fee Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --border: #e2e8f0; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto 30px; }
        h3 { color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 10px; outline: none; font-family: inherit; }
        .btn-save { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f1f5f9; color: #64748b; }
        td { padding: 15px 12px; border-bottom: 1px solid var(--border); }
        .btn-action { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .approve { background: var(--success); color: white; margin-right: 5px; }
        .reject { background: var(--danger); color: white; }
        .status-badge { padding: 5px 10px; border-radius: 5px; font-size: 0.85rem; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body>

<div class="card">
    <h3>Update Fee Structure</h3>
    <div class="form-grid">
        <select id="type">
            <option value="AC">AC Room</option>
            <option value="NON-AC">Non-AC Room</option>
        </select>
        <input type="number" id="rent" placeholder="Rent">
        <input type="number" id="mess" placeholder="Mess">
        <input type="number" id="electricity" placeholder="Electricity">
        <input type="number" id="maintenance" placeholder="Maintenance">
        <input type="text" id="upi" class="full-width" placeholder="Admin UPI ID">
        <button onclick="updateFee()" class="btn-save full-width">Save & Update Structure</button>
    </div>
</div>

<div class="card">
    <h3>Pending Student Verifications</h3>
    <table>
        <thead>
        <tr>
            <th>Student Details</th>
            <th>Transaction ID (UTR)</th>
            <th>Amount</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="pendingTable"></tbody>
    </table>
</div>

<div class="card">
    <h3 style="color: var(--success);">Archived (Verified Payments)</h3>
    <table>
        <thead>
        <tr>
            <th>Student Details</th>
            <th>Transaction ID (UTR)</th>
            <th>Amount</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody id="archiveTable"></tbody>
    </table>
</div>

<script>
    async function updateFee() {
        const roomType = document.getElementById('type').value;
        const body = {
            roomType: roomType,
            rent: parseFloat(document.getElementById('rent').value) || 0,
            mess: parseFloat(document.getElementById('mess').value) || 0,
            electricity: parseFloat(document.getElementById('electricity').value) || 0,
            maintenance: parseFloat(document.getElementById('maintenance').value) || 0,
            adminUpiId: document.getElementById('upi').value
        };

        try {
            const res = await fetch('http://localhost:8080/api/fees/admin/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) {
                Swal.fire("Success", `Fee structure for ${roomType} updated successfully`, "success");
            }
        } catch (err) {
            Swal.fire("Error", "Could not update fee structure", "error");
        }
    }

    async function loadPayments() {
        try {
            // Fetching from the all-payments endpoint for the archive
            const res = await fetch('http://localhost:8080/api/fees/admin/all-payments');
            const payments = await res.json();

            const pendingTable = document.getElementById('pendingTable');
            const archiveTable = document.getElementById('archiveTable');

            pendingTable.innerHTML = "";
            archiveTable.innerHTML = "";

            payments.forEach(p => {
                if (p.status === 'PENDING') {
                    pendingTable.innerHTML += `
                        <tr>
                            <td>
                                <b style="font-size: 1.1rem;">${p.studentName || "Student"}</b><br>
                                <small style="color: #64748b">${p.registrationNumber}</small>
                            </td>
                            <td style="font-family: monospace; color: #6366f1;">${p.transactionId}</td>
                            <td>₹${p.amount}</td>
                            <td>
                                <button class="approve btn-action" onclick="verify(${p.id}, 'SUCCESSFUL')">Approve</button>
                                <button class="reject btn-action" onclick="verify(${p.id}, 'REJECTED')">Reject</button>
                            </td>
                        </tr>
                    `;
                } else if (p.status === 'SUCCESSFUL') {
                    archiveTable.innerHTML += `
                        <tr>
                            <td>
                                <b>${p.studentName || "Student"}</b><br>
                                <small style="color: #64748b">${p.registrationNumber}</small>
                            </td>
                            <td style="font-family: monospace;">${p.transactionId}</td>
                            <td>₹${p.amount}</td>
                            <td><span class="status-badge badge-success">✓ Verified</span></td>
                        </tr>
                    `;
                }
            });
        } catch (error) {
            console.error("Error loading payments:", error);
        }
    }

    async function verify(id, status) {
        try {
            const res = await fetch(`http://localhost:8080/api/fees/admin/verify/${id}?status=${status}`, { method: 'PUT' });
            if(res.ok) {
                Swal.fire("Verified", `Payment marked as ${status}`, "success");
                loadPayments();
            }
        } catch (err) {
            Swal.fire("Error", "Verification failed", "error");
        }
    }

    window.onload = loadPayments;
</script>
</body>
</html>