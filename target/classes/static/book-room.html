<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Residence | Student</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; background: #f1f5f9; padding: 20px; border-radius: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 400px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="card">
    <div id="msgArea"></div>
    <h2>Assigned Room</h2>
    <div class="grid">
        <div><small>ROOM</small><p id="r">Not Assigned</p></div>
        <div><small>BED</small><p id="b">-</p></div>
        <div><small>ADMIN</small><p>Verified</p></div>
    </div>
    <button onclick="document.getElementById('m').style.display='flex'" style="width:100%; padding:15px; border:2px dashed #6366f1; color:#6366f1; cursor:pointer; background:none; font-weight:bold">Request Change</button>
</div>

<div id="m" class="modal">
    <div class="modal-content">
        <h3>Change Request</h3>
        <input id="fName" placeholder="Full Name">
        <input id="br" placeholder="Branch">
        <input id="cr" readonly placeholder="Current Room">
        <p style="font-size: 11px; margin: 5px 0 0 0; color: #64748b;">Preference 1</p>
        <select id="p1" class="dyn-floor"></select>
        <p style="font-size: 11px; margin: 5px 0 0 0; color: #64748b;">Preference 2</p>
        <select id="p2" class="dyn-floor"></select>
        <button onclick="submitReq()" style="width:100%; padding:10px; background:#6366f1; color:white; border:none; border-radius:8px; cursor:pointer">Submit</button>
        <button onclick="document.getElementById('m').style.display='none'" style="width:100%; border:none; background:none; cursor:pointer; margin-top:10px">Cancel</button>
    </div>
</div>

<script>
    const user = JSON.parse(localStorage.getItem('currentUser'));
    async function load() {
        const students = await (await fetch(`http://localhost:8080/api/students/all`)).json();
        const me = students.find(s => s.registrationNumber === user.registrationNumber);
        if(me && me.assignedRoom) {
            document.getElementById("r").innerText = me.assignedRoom;
            document.getElementById("b").innerText = me.assignedBed;
            document.getElementById("cr").value = me.assignedRoom;
        }

        const rooms = await (await fetch(`http://localhost:8080/api/rooms/all`)).json();
        const uniqueFloors = [...new Set(rooms.map(r => r.floor))].sort((a,b) => a - b);
        const selectors = document.querySelectorAll(".dyn-floor");

        selectors.forEach(sel => {
            sel.innerHTML = '<option value="">Select Preferred Floor</option>';
            uniqueFloors.forEach(f => {
                const types = ["AC", "Non-AC"];
                types.forEach(t => {
                    const opt = document.createElement("option");
                    opt.value = `Floor ${f} ${t}`;
                    opt.innerText = `Floor ${f} (${t})`;
                    sel.appendChild(opt);
                });
            });
        });

        const reqs = await (await fetch(`http://localhost:8080/api/students/requests/all`)).json();
        const myReq = reqs.filter(r => r.registrationNumber === user.registrationNumber).pop();
        if(myReq) {
            const area = document.getElementById("msgArea");
            if(myReq.status === 'ACCEPTED') area.innerHTML = `<div class="alert" style="background:#dcfce7; color:#166534">Room is changed by admin.</div>`;
            if(myReq.status === 'REJECTED') area.innerHTML = `<div class="alert" style="background:#fee2e2; color:#991b1b">Rooms as per preference not available. Request rejected.</div>`;
            if(myReq.status === 'PENDING') area.innerHTML = `<div class="alert" style="background:#fef3c7; color:#92400e">Request is currently PENDING. You cannot submit a new one yet.</div>`;
        }
    }

    async function submitReq() {
        const body = {
            registrationNumber: user.registrationNumber,
            fullName: document.getElementById("fName").value,
            branch: document.getElementById("br").value,
            currentRoom: document.getElementById("cr").value,
            preference1: document.getElementById("p1").value,
            preference2: document.getElementById("p2").value
        };

        const response = await fetch(`http://localhost:8080/api/students/requestChange`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
        });

        if(response.ok) {
            Swal.fire("Sent", "Successfully sent request", "success");
            document.getElementById('m').style.display='none';
            load();
        } else {
            const errorMsg = await response.text();
            Swal.fire("Blocked", errorMsg, "warning");
        }
    }
    window.onload = load;
</script>
</body>
</html>